<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <title>説明会一覧（学生用）</title>
    <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #fafafa;
    }

    /* 上部メニュー */
    header {
      border-bottom: 1px solid #ccc;
      padding: 16px 40px;
      display: flex;
      justify-content: center;
      gap: 80px;
      font-size: 14px;
      background-color: #fff;
    }

    header a {
      text-decoration: none;
      color: #333;
      cursor: pointer;
    }

    main {
      max-width: 900px;
      margin: 30px auto 60px;
      padding: 0 16px;
    }

    /* 検索フォーム */
    .search-box {
      margin: 0 auto 30px;
      max-width: 600px;
      border: 1px solid #333;
      padding: 16px;
      text-align: center;
      background-color: #fff;
    }

    .search-box input {
      width: 70%;
      padding: 6px 8px;
      box-sizing: border-box;
    }

    .search-box button {
      padding: 6px 12px;
      margin-left: 8px;
      cursor: pointer;
    }

    /* 説明会リスト */
    #eventList {
      margin-top: 20px;
    }

    .event-card {
      border: 1px solid #333;
      background-color: #fff;
      margin-bottom: 12px;
    }

    .event-header {
      padding: 10px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: default;
    }

    .event-main-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .event-title {
      font-weight: bold;
    }

    .event-sub {
      font-size: 13px;
    }

    .detail-toggle-btn {
      padding: 4px 8px;
      cursor: pointer;
      font-size: 12px;
    }

    .event-detail {
      border-top: 1px solid #333;
      padding: 10px 16px 14px;
      display: none; /* アコーディオンなので普段は非表示 */
      font-size: 14px;
    }

    .event-detail-title {
      font-weight: bold;
      margin-top: 6px;
      margin-bottom: 4px;
    }

    .reserve-btn {
      margin-top: 10px;
      padding: 6px 12px;
      cursor: pointer;
    }

    /* ページネーション */
    #pagination {
      text-align: center;
      margin-top: 24px;
      font-size: 14px;
    }

    .page-link {
      display: inline-block;
      margin: 0 6px;
      cursor: pointer;
    }

    .page-link.active {
      font-weight: bold;
      text-decoration: underline;
    }

    .message {
      text-align: center;
      margin-top: 20px;
      color: #666;
    }
  </style>
  </head>
  <body>

    <header>
      <a>予約確認</a>
      <a id="loginLink" href="login.html">ログイン</a>
      <a id="registerLink" href="register.html">新規登録</a>
      <a>アカウント</a>
    </header>

    <main>
      <!-- 検索フォーム（見た目だけ。検索APIは後で実装） -->
      <div class="search-box">
        <input id="keyword" type="text" placeholder="会社名・説明会名などで検索">
        <button id="searchBtn">検索</button>
      </div>

      <!-- 説明会リスト -->
      <div id="eventList"></div>

      <!-- 件数ゼロなどのお知らせ -->
      <div id="message" class="message"></div>

      <!-- ページネーション -->
      <div id="pagination"></div>
    </main>

    <script>
  // =============================
  // 設定
  // =============================
  const API_BASE = "http://localhost:8080";  // Spring Boot のURL
  const PAGE_SIZE = 10;

  let currentPage = 0;
  let totalPages = 1;

  // ログイン情報取得（login.html 側で localStorage に保存している前提）
  function getLoginInfo() {
    const token = localStorage.getItem("token");
    const roleRaw = localStorage.getItem("role"); // "student" / "STUDENT" を想定
    const role = roleRaw ? roleRaw.toUpperCase() : null;

    return { token, role };
  }

  // 締切日が過ぎているか判定（event.deadline は "2025-12-20" 形式を想定）
  function isDeadlineOver(deadlineStr) {
    if (!deadlineStr) return false;
    const d = new Date(deadlineStr);
    if (Number.isNaN(d.getTime())) return false; // パースできない場合は締切なし扱い

    const today = new Date();
    d.setHours(0,0,0,0);
    today.setHours(0,0,0,0);

    return d < today;
  }

  // ヘッダーの「ログイン」を「ログアウト」に差し替え
function setupHeaderByLoginStatus() {
  const loginLink = document.getElementById("loginLink");
  const registerLink = document.getElementById("registerLink");
  const { token } = getLoginInfo();

  if (!loginLink) return;

  if (token) {
    // ★ ログイン済み → ログアウト表示に変更
    loginLink.textContent = "ログアウト";
    loginLink.href = "#";

    // 既存のイベントを消しておく（念のため）
    loginLink.replaceWith(loginLink.cloneNode(true));
    const newLoginLink = document.getElementById("loginLink");

    newLoginLink.addEventListener("click", (e) => {
      e.preventDefault();

      // localStorage をクリア（savedEmail は残したければ残してOK）
      localStorage.removeItem("token");
      localStorage.removeItem("userId");
      localStorage.removeItem("email");
      localStorage.removeItem("name");
      localStorage.removeItem("role");

      alert("ログアウトしました。");

      // index.html画面へ移動
      window.location.href = "index.html";
    });

    // お好み：ログイン済みなら「新規登録」を隠す
    if (registerLink) {
      registerLink.style.display = "none";
    }
  } else {
    // ★ 未ログイン → 通常のログインリンク
    loginLink.textContent = "ログイン";
    loginLink.href = "login.html";

    if (registerLink) {
      registerLink.style.display = "inline";
    }
  }
}

  // =============================
  // API呼び出し
  // =============================
  async function loadEvents(page) {
    if (page < 0) page = 0;

    const params = new URLSearchParams({
      page: page,
      size: PAGE_SIZE
      // 検索機能をつけるなら keyword などを追加
    });

    try {
      const res = await fetch(`${API_BASE}/events?` + params.toString());
      if (!res.ok) {
        throw new Error("HTTP status " + res.status);
      }

      const data = await res.json();
      currentPage = data.page;
      totalPages = data.totalPages;

      renderEvents(data.events);
      renderPagination();
      renderMessage(data.totalCount);
    } catch (err) {
      console.error(err);
      document.getElementById("eventList").innerHTML = "";
      document.getElementById("pagination").innerHTML = "";
      document.getElementById("message").textContent =
        "説明会情報の取得に失敗しました。サーバーを確認してください。";
    }
  }

  // =============================
  // 画面描画
  // =============================

  function renderEvents(events) {
    const list = document.getElementById("eventList");
    list.innerHTML = "";

    const loginInfo = getLoginInfo();
    const isStudent = loginInfo.role === "STUDENT";

    events.forEach(event => {
      const card = document.createElement("div");
      card.className = "event-card";

      // --- ヘッダー（会社名／開催日／場所） ---
      const header = document.createElement("div");
      header.className = "event-header";

      const mainInfo = document.createElement("div");
      mainInfo.className = "event-main-info";

      // ★ タイトル：会社名
      const title = document.createElement("div");
      title.className = "event-title";
      title.textContent = event.companyName ?? "会社名未設定";

      const sub1 = document.createElement("div");
      sub1.className = "event-sub";
      sub1.textContent = `開催日：${event.date ?? "未定"}`;

      const sub2 = document.createElement("div");
      sub2.className = "event-sub";
      sub2.textContent = `場所：${event.place ?? "未定"}`;

      mainInfo.appendChild(title);
      mainInfo.appendChild(sub1);
      mainInfo.appendChild(sub2);

      const toggleBtn = document.createElement("button");
      toggleBtn.className = "detail-toggle-btn";
      toggleBtn.textContent = "▽ 詳細表示";

      header.appendChild(mainInfo);
      header.appendChild(toggleBtn);

      // --- アコーディオン部分 ---
      const detail = document.createElement("div");
      detail.className = "event-detail";

       const deadlineTitle = document.createElement("div");
      deadlineTitle.className = "event-detail-title";
      deadlineTitle.textContent = "締切";

      const deadlineBody = document.createElement("div");
      deadlineBody.textContent = event.deadline || "締切は未設定です。";

      // 説明会名（元の item）
      const itemTitle = document.createElement("div");
      itemTitle.className = "event-detail-title";
      itemTitle.textContent = "持ち物";

      const itemBody = document.createElement("div");
      itemBody.textContent = event.item || "持ち物情報は未登録です。";

      // 説明（note）
      const noteTitle = document.createElement("div");
      noteTitle.className = "event-detail-title";
      noteTitle.textContent = "説明";

      const noteBody = document.createElement("div");
      noteBody.textContent = event.note || "詳細情報は未登録です。";

      const reserveBtn = document.createElement("button");
      reserveBtn.className = "reserve-btn";
      reserveBtn.textContent = "予約する";
      //予約機能
      // --- 締切＆roleによる制御 ---
      const deadlineOver = isDeadlineOver(event.deadline);

       if (deadlineOver) {
        // 締切日を過ぎている場合 → ボタンはグレーで押せない
        reserveBtn.disabled = true;
        reserveBtn.style.backgroundColor = "#ccc";
        reserveBtn.style.cursor = "not-allowed";
        reserveBtn.textContent = "締切済み";
      } else if (!isStudent) {
        // 学生アカウント以外 → 予約できない
        reserveBtn.disabled = true;
        reserveBtn.style.backgroundColor = "#ccc";
        reserveBtn.style.cursor = "not-allowed";
        reserveBtn.textContent = "学生のみ予約可";
      } else {
        // 学生 かつ 締切前 → 予約可能
        reserveBtn.addEventListener("click", async () => {
          // ★ ここで確認ダイアログを出す
          const ok = window.confirm(
            `この説明会を予約しますか？\n\n` +
            `会社名：${event.companyName ?? "会社名未設定"}\n` +
            `開催日：${event.date ?? "未定"}\n` +
            `場所：${event.place ?? "未定"}`
          );
          if (!ok) {
           // 「キャンセル」が押されたら何もしない
            return;
          }
          const token = loginInfo.token;
          if (!token) {
            alert("予約にはログインが必要です。ログイン画面から再度ログインしてください。");
            // location.href = "login.html"; // 必要ならリダイレクト
            return;
          }

          try {
            // eventId はバックエンドの Event DTO が持っている前提
            const res = await fetch(`${API_BASE}/events/${event.eventId}/reservations`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token
              }
            });

            if (res.ok) {
              alert("予約が完了しました。");
            } else if (res.status === 400 || res.status === 409) {
              const msg = await res.text();
              alert("予約に失敗しました: " + msg);
            } else if (res.status === 401 || res.status === 403) {
              alert("権限がありません。学生アカウントでログインしてください。");
            } else {
              alert("予期しないエラーが発生しました。");
            }
          } catch (e) {
            console.error(e);
            alert("サーバーとの通信に失敗しました。");
          }
        });
      }
      
      detail.appendChild(deadlineTitle);
      detail.appendChild(deadlineBody);
      detail.appendChild(itemTitle);
      detail.appendChild(itemBody);
      detail.appendChild(noteTitle);
      detail.appendChild(noteBody);
      detail.appendChild(reserveBtn);

      // アコーディオン開閉
      toggleBtn.addEventListener("click", () => {
        const isOpen = detail.style.display === "block";
        detail.style.display = isOpen ? "none" : "block";
        toggleBtn.textContent = isOpen ? "▽ 詳細表示" : "△ 閉じる";
      });

      card.appendChild(header);
      card.appendChild(detail);
      list.appendChild(card);
    });
  }

  function renderPagination() {
    const container = document.getElementById("pagination");
    container.innerHTML = "";

    if (totalPages <= 1) {
      return; // 1ページしか無い時は何も表示しない
    }

    for (let i = 0; i < totalPages; i++) {
      const span = document.createElement("span");
      span.className = "page-link" + (i === currentPage ? " active" : "");
      span.textContent = (i + 1);
      span.addEventListener("click", () => loadEvents(i));
      container.appendChild(span);
    }

    if (currentPage < totalPages - 1) {
      const next = document.createElement("span");
      next.className = "page-link";
      next.textContent = ">>next";
      next.addEventListener("click", () => loadEvents(currentPage + 1));
      container.appendChild(next);
    }
  }

  function renderMessage(totalCount) {
    const msg = document.getElementById("message");
    if (totalCount === 0) {
      msg.textContent = "現在、表示できる説明会がありません。";
    } else {
      msg.textContent = "";
    }
  }

  // =============================
  // 初期化
  // =============================
  window.addEventListener("load", () => {
    setupHeaderByLoginStatus();
    loadEvents(0);

    // 検索ボタン（今はリロードだけ。検索APIを作ったらここを書き換える）
    document.getElementById("searchBtn").addEventListener("click", () => {
      // const keyword = document.getElementById("keyword").value;
      // keyword をクエリパラメータにつけるなどしてAPI側と連携する
      loadEvents(0);
    });
  });
</script>

  </body>
</html>
